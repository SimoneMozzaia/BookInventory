name: CI + SonarCloud

on:
  push:
    branches: [ "main" ]
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    env:
      DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
      DJANGO_DEBUG: "false"
      DJANGO_ALLOWED_HOSTS: "localhost,127.0.0.1"
      MYSQL_HOST: "127.0.0.1"
      MYSQL_PORT: "3306"
      MYSQL_DB: ${{ secrets.MYSQL_DB }}
      MYSQL_USER: ${{ secrets.MYSQL_USER }}
      MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install backend deps (with dev tools)
        working-directory: backend
        env:
          POETRY_VIRTUALENVS_IN_PROJECT: "true"
          POETRY_NO_INTERACTION: "1"
        run: |
          poetry install --with dev

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install frontend deps
        working-directory: frontend
        run: npm ci

      - name: Frontend tests with coverage (LCOV)
        working-directory: frontend
        run: npm run test:coverage

      - name: Generate external reports (Ruff, Mypy)
        env:
          POETRY_VIRTUALENVS_IN_PROJECT: "true"
        run: |
          mkdir -p reports

          # Ruff JSON
          backend/.venv/bin/ruff check backend --output-format json --output-file reports/ruff.json --exit-zero

          # Mypy text report
          backend/.venv/bin/mypy backend/config backend/apps backend/tests \
            --show-column-numbers --no-error-summary --pretty false \
            > reports/mypy.txt || true

          # ESLint JSON
          cd frontend
          npx eslint . -f json -o ../reports/eslint.json || true
          cd ..

      - name: Run tests with coverage (Python)
        working-directory: backend
        env:
          POETRY_VIRTUALENVS_IN_PROJECT: "true"
        run: |
          ../backend/.venv/bin/coverage run -m pytest
          ../backend/.venv/bin/coverage xml -o ../reports/coverage.xml

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v7
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
