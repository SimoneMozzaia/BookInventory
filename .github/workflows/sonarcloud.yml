name: CI + SonarCloud

on:
  push:
    branches: [ "main" ]
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Install backend deps (with dev tools)
        working-directory: backend
        env:
          POETRY_VIRTUALENVS_IN_PROJECT: "true"
          POETRY_NO_INTERACTION: "1"
        run: |
          poetry install --with dev

      - name: Generate external reports (Ruff, Mypy)
        env:
          POETRY_VIRTUALENVS_IN_PROJECT: "true"
        run: |
          mkdir -p reports

          # Ruff JSON
          backend/.venv/bin/ruff check backend --output-format json --output-file reports/ruff.json --exit-zero

          # Mypy text report
          backend/.venv/bin/mypy backend/config backend/apps backend/tests \
            --show-column-numbers --no-error-summary --pretty false \
            > reports/mypy.txt || true

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v7
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
